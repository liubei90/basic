# 微信小程序消息功能

作为小程序服务提供方，有向用户推送消息的需求，用来在用户离开小程序后通知用户状态发生变更。实现服务的闭环和更优的体验，比如

- 使用地铁乘车码扫码进站出站，会在服务通知窗口收到推送乘车通知
- 使用抽奖小程序，会在开奖后收到开奖结果通知

微信提供了3个向用户下发通知消息的方法

1. 模板消息（已废弃）
2. 统一服务消息（即将废弃）
3. 订阅消息

## 订阅消息

订阅消息包括**一次性订阅消息** 和**长期订阅消息**，用来满足服务的后续通知问题，**长期订阅消息**只向线下公共服务领域开放。

**一次性订阅消息**实现步骤：

1. 在微信公众平台手动配置并获取模板ID。如果没有合适的模板，可以申请添加新模板，审核通过后可使用（并没有看到申请入口，据说要在论坛发帖[手动狗头.jpg]）。
2. 小程序内，用户使用了需要后续通知的服务时，调用**wx.requestSubscribeMessage**唤起订阅消息界面，用户同意订阅后才能收到后续的通知。**wx.requestSubscribeMessage**函数必须在按钮点击事件函数内执行。
3. 服务端在后续服务结束后，调用发送消息接口通知微信，下发用户订阅的消息

可以看到，**一次性订阅消息**实现的理念就是一次服务，一次通知，且需要用户授权。这样做的好处是规范通知消息的内容，不给服务提供商多次打扰用户的机会。防止服务提供商使用推送消息达到其他目的（比如推送广告和活动）。

模板消息对用户是无感的，也就是不需要用户授权，开发者可以用过一定的技术手段，实现类似**长期订阅消息**的效果，由于微信废弃了该机制，普通服务提供方基本没可能使用**长期订阅消息**的功能。

相关链接：
[小程序订阅消息](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)
[小程序订阅消息开发指南](https://developers.weixin.qq.com/community/develop/article/doc/00026407d58cf07bb96941b0e5b813)
[微信小程序推送公众号模版消息](https://www.jianshu.com/p/5fb1fedfee62)
